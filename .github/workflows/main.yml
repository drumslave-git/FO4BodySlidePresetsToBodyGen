on:
  push:
    branches:
    - main

jobs:
  packageChange:
    runs-on: ubuntu-latest
    outputs:
      package: ${{ steps.changes.outputs.package }}
    steps:
    - uses: actions/checkout@v4
    - uses: dorny/paths-filter@v3
      id: changes
      with:
        filters: |
          package:
            - './package.json'

  release:
    permissions:
      contents: write
    runs-on: windows-latest
    needs: packageChange
    if: ${{ needs.packageChange.outputs.package == 'true' }}
    steps:
    - uses: actions/setup-node@v4
    - uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    - uses: actions/checkout@v4
    - name: Install deps
      run: npm ci
    - name: Build .NET
      run: npm run dotnet:build
    - name: Publish
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: npm run publish
